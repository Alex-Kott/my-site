
<div class="header">
	<div>
		<span class="title">Django-блог</span>
	</div>
	<div id="auth-buttons">
		<button id="login">Войти</button>
		<button id="logout">Выйти</button>
	</div>

</div>


<div class="main">
	<form method="POST">
		{% csrf_token %}
		<div class="posts">
		{% if posts %}
			{% for post in posts %}
				<div class='post'>
					<div class='author'>{{ post.author }} пишет:</div>
					<div class='text'>{{ post.post_text }}</div>
				</div>

			{% endfor %}
		{% else %}
			<h2> В блоге ещё нет постов </h2>
		{% endif %}


		</div>
		<div class="editWindow">
			<input type="text" name="txt" class="txt">
			<input type="text" name="username" class="username" placeholder="Автор">
		</div>
		
		<input type="submit" class="savePost" value="Сохранить пост">
		<input type="button" class="addPost" value="Добавить пост">
	</form>
</div>


<style>
.header{
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content:  space-between;
	padding: 15px;
}

.title{
	color: white;
	text-shadow: 1px 1px 2px black;
	font-size: 3em;
}

#logout{
	display: none;
}

#auth-buttons button{
	width: 200px;
	height: 50px;
	border-radius: 10px;
	margin: 10px;

}

#login{
	background: #5cb85c;
	border: 0;
}

#logout{
	background: #d9534f;
	border: 0;
}

.main{
	width: 70%;
	margin: 0 auto;
}

.post{
	margin: 0 auto;
}

.editWindow{
	display: none;
}

input[type=text]{
	width: 100%;
	border-radius: 10px;
	padding: 5px;
	margin: 5px 0;
}

textarea, .txt{
	width: 100%;
	min-height: 150px;
	border-radius: 10px;
	outline: none;
	padding: 15px;
	font-size: 1.3em;
}

.addPost, .savePost{
	width: 100%;
	background: #337ab7;
	border-radius: 10px;
	padding: 10px;
	color: white;
	font-size: 1.2em;
	font-weight: bold;
	border: 0;
	margin: 10px 0;
}

.savePost{
	display: none;
}

.post{
	background: #ccc;
	border-radius: 10px;
	padding: 10px;
	margin: 10px 0;
}

.author{
	opacity: 0.5;
	margin: 10px;
}
</style>

<script src="https://vk.com/js/api/openapi.js" type="text/javascript"></script>
<script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
<script>

var user_id;
var group_link;
var group_id;
var secondOrderFriends = [];
var uniqFriends = [];
var nMutualFriends = [];
var userFriends = [];
var timeStamp;
var intervalIds;
var timeoutStack = [];
var isLogin = false;
var to = 500; // timeout. По хорошему его нужно автоматически вычислять в зависимости от кол-ва друзей у юзера


var vk = {
    data: {},
    appID: 5955203,
    appPermissions: 4260874,
    init: function() {
        (window.vkAsyncInit = function() {
            VK.init({
                apiId: vk.appID
            });
            VK.Auth.login(authInfo, vk.appPermissions);

            function authInfo(response) {
                //console.log(response);
                if (response.session) {
                    vk.data.user = response.session.user;
                    $("#user").val(vk.data.user.href);
                    $("#login").css({"display":"none"});
                    $("#logout").css({"display":"block"});
                    isLogin = true;
                    
                    var author = vk.data.user.first_name+" "+vk.data.user.last_name;
                    $(".username").val(author);

                    user_link = $("#user").val();
				    var re = /\/{0}\w*$/ig;
				    var screen_name = re.exec(user_link);
				    setUserId(screen_name[0]);
                } else alert("Не удалось войти!");
            }
        })();
    }
}

$(document).ready(vk.init());

$("#login").on("click", function(){
	vk.init();
})

$("#logout").on("click", function(){
	$("#stop-search").trigger("click");
	VK.Auth.logout(function(r){
		$("#login").css({"display":"block"});
		$("#logout").css({"display":"none"});
		isLogin = false;
	})
})

function setUserId(screen_name) {
    VK.Api.call('users.get', {
        user_ids: screen_name
    }, function(r) {
        user_id = r.response[0].uid;
    })
}


$(".addPost").on("click", function(){
	$(".editWindow").fadeIn(150)
	$(".addPost").fadeOut(150);
	$(".savePost").fadeIn(150);
});

// var posts = [];

$(".savepost").on("click", function(){
	var posts = JSON.parse(localStorage.getItem("posts"))
	if(posts === null){
		posts = new Array();
	}
	try{
		var author = vk.data.user.first_name+" "+vk.data.user.last_name;
	} catch(err){
		console.log(err)
		author = "User1"
	}


	var text = $("textarea").val()
	var post = {
		text: text,
		author: author
	}
	posts.push(post);
	localStorage.setItem("posts", JSON.stringify(posts))

	$("textarea").val("")

	$(".editWindow").fadeOut(200);
	$(".savePost").fadeOut(200);
	$(".addPost").fadeIn(200);
})



</script>